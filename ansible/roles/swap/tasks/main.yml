---
- name: Get system memory information
  set_fact:
    system_memory_mb: "{{ ansible_memtotal_mb }}"
    required_swap_mb: "{{ (ansible_memtotal_mb * 0.5) | int }}"

- name: Check current swap size
  shell: free -m | grep -i swap | awk '{print $2}'
  register: current_swap_mb
  changed_when: false

- name: Display memory and swap information
  debug:
    msg:
      - "System RAM: {{ system_memory_mb }} MB"
      - "Current swap: {{ current_swap_mb.stdout }} MB"
      - "Required swap (50% of RAM): {{ required_swap_mb }} MB"

- name: Determine if swap needs to be created or increased
  set_fact:
    need_swap: "{{ (current_swap_mb.stdout | int) < (required_swap_mb | int) }}"
    swap_size_to_add: "{{ (required_swap_mb | int) - (current_swap_mb.stdout | int) }}"

- name: Check if swap file exists
  stat:
    path: /swapfile
  register: swap_file_stat

- name: Create or resize swap file
  block:
    - name: Create swap file
      command: fallocate -l {{ required_swap_mb }}M /swapfile
      when: not swap_file_stat.stat.exists

    - name: Disable existing swap if resizing
      command: swapoff /swapfile
      when: swap_file_stat.stat.exists and need_swap

    - name: Resize existing swap file
      command: fallocate -l {{ required_swap_mb }}M /swapfile
      when: swap_file_stat.stat.exists and need_swap

    - name: Set swap file permissions
      file:
        path: /swapfile
        owner: root
        group: root
        mode: '0600'

    - name: Make swap file
      command: mkswap /swapfile
      when: need_swap or not swap_file_stat.stat.exists

    - name: Enable swap file
      command: swapon /swapfile
      when: need_swap or not swap_file_stat.stat.exists

    - name: Add swap to /etc/fstab
      lineinfile:
        path: /etc/fstab
        regexp: '^/swapfile'
        line: '/swapfile none swap sw 0 0'
        state: present
      when: need_swap or not swap_file_stat.stat.exists

  when: need_swap or not swap_file_stat.stat.exists

- name: Configure swappiness
  sysctl:
    name: vm.swappiness
    value: '60'
    state: present
    sysctl_set: yes
    reload: yes

- name: Configure cache pressure
  sysctl:
    name: vm.vfs_cache_pressure
    value: '50'
    state: present
    sysctl_set: yes
    reload: yes

- name: Verify swap is active
  shell: free -m | grep -i swap
  register: swap_status
  changed_when: false

- name: Display final swap status
  debug:
    msg: "Swap status: {{ swap_status.stdout }}"