# ============================================================================
# DSpace 9 Installation Testing with Vagrant
# ============================================================================
#
# PURPOSE: This GitHub Action is for CI TESTING purposes only!
#          It creates a Vagrant VM with Ubuntu 24.04 LTS and tests the
#          complete DSpace installation using Ansible.
#
# REQUIREMENTS:
# - Runs on macOS runners (which support hardware virtualization)
# - Creates a real VM using Vagrant (not a container)
# - Tests the full installation process as it would run on developer machines
#
# ============================================================================

name: Test DSpace Installation (Vagrant)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of installation to test'
        required: true
        default: 'complete'
        type: choice
        options:
          - complete      # Full installation (backend + frontend)
          - backend       # Backend only with prerequisites
          - prerequisites # Just prerequisites
      verbose:
        description: 'Enable verbose Ansible output'
        required: false
        default: false
        type: boolean

# Prevent multiple runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  vagrant-test:
    # Use macOS runner which supports hardware virtualization for Vagrant
    # Note: This is more expensive than Linux runners in terms of GitHub Actions minutes
    runs-on: macos-latest

    timeout-minutes: 120  # 2 hours max (DSpace build can be slow)

    steps:
      # ======================================================================
      # Step 1: Checkout Repository
      # ======================================================================
      - name: "ðŸ“¦ Checkout repository"
        uses: actions/checkout@v4

      # ======================================================================
      # Step 2: System Information
      # ======================================================================
      - name: "â„¹ï¸ System information"
        run: |
          echo "================================================"
          echo "CI Testing Environment Information"
          echo "================================================"
          echo "Runner OS: $(uname -s)"
          echo "Runner Version: $(uname -r)"
          echo "Runner Architecture: $(uname -m)"
          echo "Available CPU cores: $(sysctl -n hw.ncpu)"
          echo "Available memory: $(( $(sysctl -n hw.memsize) / 1073741824 )) GB"
          echo "Available disk space:"
          df -h /
          echo "================================================"

      # ======================================================================
      # Step 3: Install Dependencies
      # ======================================================================
      - name: "ðŸ”§ Install Vagrant and dependencies"
        run: |
          echo "================================================"
          echo "Installing Vagrant and dependencies for CI testing"
          echo "================================================"

          # Detect architecture
          ARCH=$(uname -m)
          echo "System architecture: $ARCH"

          # Install or update Homebrew
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || brew update

          # Install Vagrant
          brew install --cask vagrant

          # Install virtualization provider based on architecture
          PROVIDER_INSTALLED=false

          if [[ "$ARCH" == "arm64" ]]; then
            echo "Installing virtualization for Apple Silicon (ARM64)..."
            # For ARM64, use QEMU as it's free and works reliably
            echo "Installing QEMU for ARM64..."
            if brew install qemu; then
              vagrant plugin install vagrant-qemu
              PROVIDER_INSTALLED=true
              PROVIDER_TYPE="qemu"
            fi
          else
            echo "Installing VirtualBox for Intel architecture..."
            # For Intel, try VirtualBox first
            if brew install --cask virtualbox 2>/dev/null; then
              PROVIDER_INSTALLED=true
              PROVIDER_TYPE="virtualbox"
            else
              echo "VirtualBox installation failed (may require permissions), trying Docker..."
              # Fallback to Docker if VirtualBox fails
              if brew install --cask docker 2>/dev/null; then
                vagrant plugin install vagrant-docker-provider
                PROVIDER_INSTALLED=true
                PROVIDER_TYPE="docker"
              fi
            fi
          fi

          # Install Python and Ansible
          brew install python@3.11

          # Install pipx and Ansible
          brew install pipx
          pipx ensurepath
          export PATH="$HOME/.local/bin:$PATH"
          pipx install --include-deps ansible

          # Verify installations
          echo ""
          echo "Verifying installations:"
          vagrant --version

          # Check which provider is actually available and working
          if [ "$PROVIDER_INSTALLED" = true ]; then
            case "$PROVIDER_TYPE" in
              virtualbox)
                if VBoxManage --version 2>/dev/null; then
                  echo "Provider: VirtualBox"
                  echo "VAGRANT_DEFAULT_PROVIDER=virtualbox" >> $GITHUB_ENV
                else
                  echo "âš ï¸ VirtualBox installed but not working!"
                  exit 1
                fi
                ;;
              qemu)
                if command -v qemu-system-aarch64 &> /dev/null || command -v qemu-system-x86_64 &> /dev/null; then
                  qemu-system-aarch64 --version 2>/dev/null || qemu-system-x86_64 --version
                  echo "Provider: QEMU"
                  echo "VAGRANT_DEFAULT_PROVIDER=qemu" >> $GITHUB_ENV
                else
                  echo "âš ï¸ QEMU installed but not working!"
                  exit 1
                fi
                ;;
              docker)
                if command -v docker &> /dev/null; then
                  echo "Provider: Docker"
                  echo "VAGRANT_DEFAULT_PROVIDER=docker" >> $GITHUB_ENV
                else
                  echo "âš ï¸ Docker installed but not working!"
                  exit 1
                fi
                ;;
            esac
          else
            echo "âš ï¸ No virtualization provider could be installed!"
            echo "CI environment may not support hardware virtualization."
            exit 1
          fi

          ansible --version

          echo "âœ… Dependencies installed successfully"

      # ======================================================================
      # Step 4: Configure Vagrant Environment
      # ======================================================================
      - name: "âš™ï¸ Configure Vagrant environment"
        run: |
          echo "================================================"
          echo "Configuring Vagrant for CI testing"
          echo "================================================"
          echo "Provider: $VAGRANT_DEFAULT_PROVIDER"

          # Create Vagrantfile based on provider
          cat > Vagrantfile << 'EOF'
          # -*- mode: ruby -*-
          # vi: set ft=ruby :

          # ============================================================================
          # CI Testing Vagrantfile for DSpace Installation
          # ============================================================================
          # This Vagrantfile is used for GitHub Actions CI testing only!
          # It creates an Ubuntu 24.04 VM for testing the installation process.
          # ============================================================================

          Vagrant.configure("2") do |config|
            # Use appropriate box based on provider
            provider = ENV['VAGRANT_DEFAULT_PROVIDER'] || 'virtualbox'

            case provider
            when 'qemu'
              # QEMU requires special boxes
              config.vm.box = "perk/ubuntu-2404-arm64"
            when 'docker'
              # Docker doesn't use boxes
              config.vm.box = nil
            else
              # VirtualBox and others
              config.vm.box = "bento/ubuntu-24.04"
            end

            config.vm.hostname = "dspace-server"

            # Provider-specific configuration
            # VirtualBox configuration
            config.vm.provider "virtualbox" do |vb|
              vb.name = "dspace-ci-test"
              vb.memory = "6144"  # 6GB RAM for CI testing
              vb.cpus = 2
              vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
              vb.customize ["modifyvm", :id, "--ioapic", "on"]
            end

            # QEMU configuration for ARM64
            config.vm.provider "qemu" do |qe|
              qe.memory = "6144"  # 6GB RAM
              qe.cpu_count = 2
              qe.arch = "aarch64"
              qe.machine = "virt"
              qe.net_device = "virtio-net-pci"
            end

            # Docker configuration as fallback
            config.vm.provider "docker" do |d|
              d.image = "ubuntu:24.04"
              d.has_ssh = true
              d.privileged = true
              d.create_args = ["--cap-add=SYS_ADMIN", "--security-opt", "apparmor=unconfined"]
            end

            # Network configuration (skip for Docker)
            if ENV['VAGRANT_DEFAULT_PROVIDER'] != 'docker'
              config.vm.network "private_network", type: "dhcp"
            end

            # Create admin user for Ansible
            config.vm.provision "shell", inline: <<-SHELL
              # Create admin user if doesn't exist
              if ! id -u admin >/dev/null 2>&1; then
                useradd -m -s /bin/bash -G sudo admin
                echo "admin:admin" | chpasswd
                echo "admin ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/admin
              fi

              # Setup SSH key authentication
              mkdir -p /home/admin/.ssh
              chmod 700 /home/admin/.ssh
              touch /home/admin/.ssh/authorized_keys
              chmod 600 /home/admin/.ssh/authorized_keys
              chown -R admin:admin /home/admin/.ssh

              # Enable password authentication temporarily for CI
              if [ -f /etc/ssh/sshd_config ]; then
                sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
                systemctl restart sshd || service ssh restart || true
              fi

              # Basic system setup
              apt-get update
              apt-get install -y python3 python3-pip python3-apt

              echo "âœ… VM provisioning complete"
            SHELL

            # Sync the project directory (provider-specific)
            if ENV['VAGRANT_DEFAULT_PROVIDER'] == 'virtualbox'
              config.vm.synced_folder ".", "/vagrant", type: "virtualbox"
            elsif ENV['VAGRANT_DEFAULT_PROVIDER'] != 'docker'
              config.vm.synced_folder ".", "/vagrant", type: "rsync"
            end
          end
          EOF

          echo "âœ… Vagrantfile configured for CI testing with provider: $VAGRANT_DEFAULT_PROVIDER"

      # ======================================================================
      # Step 5: Start Vagrant VM
      # ======================================================================
      - name: "ðŸš€ Start Vagrant VM"
        run: |
          echo "================================================"
          echo "Starting Vagrant VM for testing"
          echo "================================================"

          # Use the provider detected in previous step
          echo "Using provider: $VAGRANT_DEFAULT_PROVIDER"

          # Verify provider is set
          if [ -z "$VAGRANT_DEFAULT_PROVIDER" ]; then
            echo "âŒ Error: No provider set! Check provider detection step."
            exit 1
          fi

          # Show available providers for debugging
          echo "Available Vagrant providers:"
          vagrant plugin list

          # Start the VM with the appropriate provider
          echo "Starting VM with provider: $VAGRANT_DEFAULT_PROVIDER"
          if ! vagrant up --provider=$VAGRANT_DEFAULT_PROVIDER 2>&1 | tee vagrant-up.log; then
            echo "âŒ Failed to start VM."
            echo "Error details from log:"
            grep -E '(Error|Failed|Cannot|Unable)' vagrant-up.log | tail -n 20
            exit 1
          fi

          # Wait for VM to be fully ready
          echo "Waiting for VM to be ready..."
          sleep 10

          # Show VM status
          echo "VM Status:"
          vagrant status

          # Test SSH connectivity
          echo "Testing SSH connectivity..."
          if ! vagrant ssh -c "echo 'VM is accessible via SSH'"; then
            echo "âŒ Failed to connect to VM via SSH"
            echo "Trying to get more information..."
            vagrant ssh-config
            exit 1
          fi

          echo "âœ… Vagrant VM started successfully"

      # ======================================================================
      # Step 6: Setup SSH for Ansible
      # ======================================================================
      - name: "ðŸ”‘ Setup SSH keys for Ansible"
        run: |
          echo "================================================"
          echo "Setting up SSH for Ansible connection"
          echo "================================================"

          # Generate SSH key if doesn't exist
          if [ ! -f ~/.ssh/id_ed25519 ]; then
            ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
          fi

          # Get VM SSH info
          vagrant ssh-config > /tmp/vagrant-ssh-config
          VM_IP=$(vagrant ssh-config | grep HostName | awk '{print $2}')
          VM_PORT=$(vagrant ssh-config | grep Port | awk '{print $2}')
          VM_KEY=$(vagrant ssh-config | grep IdentityFile | awk '{print $2}')

          echo "VM IP: $VM_IP"
          echo "VM Port: $VM_PORT"

          # Copy our SSH key to the VM
          cat ~/.ssh/id_ed25519.pub | vagrant ssh -c "cat >> /home/admin/.ssh/authorized_keys"

          # Test SSH connection as admin user
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 -p $VM_PORT admin@$VM_IP "echo 'SSH as admin user works'"

          echo "âœ… SSH configured successfully"

      # ======================================================================
      # Step 7: Run Installation Tests
      # ======================================================================
      - name: "ðŸ§ª Run DSpace installation (TEST MODE)"
        run: |
          echo "================================================"
          echo "Starting DSpace Installation Test"
          echo "Test Type: ${{ github.event.inputs.test_type || 'complete' }}"
          echo "Verbose: ${{ github.event.inputs.verbose || 'false' }}"
          echo "================================================"
          echo ""
          echo "âš ï¸  THIS IS A CI TEST ENVIRONMENT âš ï¸"
          echo ""

          # Export PATH for pipx
          export PATH="$HOME/.local/bin:$PATH"

          # Set Vagrant as provider
          export PROVIDER=vagrant

          # Set verbose flag if requested
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            export ANSIBLE_VERBOSE="-vvv"
          fi

          # Configure developer machine (installs Ansible locally if needed)
          make configure-developer-machine

          # Run the appropriate test
          TEST_TYPE="${{ github.event.inputs.test_type || 'complete' }}"

          case "$TEST_TYPE" in
            prerequisites)
              echo "ðŸ“¦ Testing prerequisites installation..."
              make update-apt
              make install-prerequisites
              ;;
            backend)
              echo "ðŸ”§ Testing backend installation..."
              make update-apt
              make install-prerequisites
              make install-dspace
              ;;
            complete)
              echo "ðŸ—ï¸ Testing complete installation..."
              make update-apt
              make install-complete
              ;;
          esac

          echo ""
          echo "âœ… Installation test completed successfully!"

      # ======================================================================
      # Step 8: Validate Installation
      # ======================================================================
      - name: "âœ”ï¸ Validate installation"
        if: success()
        run: |
          echo "================================================"
          echo "Validating DSpace Installation in VM"
          echo "================================================"

          # Function to run commands in VM
          vm_exec() {
            vagrant ssh -c "$1"
          }

          # Check services
          echo "ðŸ” Checking services..."
          vm_exec "sudo systemctl is-active postgresql" && echo "âœ… PostgreSQL is running" || echo "âŒ PostgreSQL not running"
          vm_exec "sudo systemctl is-active tomcat" && echo "âœ… Tomcat is running" || echo "âŒ Tomcat not running"
          vm_exec "sudo systemctl is-active solr" && echo "âœ… Solr is running" || echo "âŒ Solr not running"

          # Check directories
          echo ""
          echo "ðŸ“ Checking directories..."
          vm_exec "test -d /opt/dspace" && echo "âœ… DSpace installed" || echo "âŒ DSpace not found"
          vm_exec "test -d /opt/solr" && echo "âœ… Solr installed" || echo "âŒ Solr not found"

          # Check database (if backend installed)
          if [[ "${{ github.event.inputs.test_type }}" != "prerequisites" ]]; then
            echo ""
            echo "ðŸ—„ï¸ Checking database..."
            vm_exec "sudo -u postgres psql -d dspace -c 'SELECT 1;'" && echo "âœ… Database accessible" || echo "âŒ Database not accessible"
          fi

          # Check frontend (if complete installation)
          if [[ "${{ github.event.inputs.test_type }}" == "complete" ]]; then
            echo ""
            echo "ðŸŒ Checking frontend..."
            vm_exec "curl -s -o /dev/null -w '%{http_code}' http://localhost:4000" | grep -q "200" && echo "âœ… Frontend responding" || echo "âš ï¸ Frontend not responding"
          fi

          echo ""
          echo "âœ… Validation complete"

      # ======================================================================
      # Step 9: Collect Logs on Failure
      # ======================================================================
      - name: "ðŸ“‹ Collect logs on failure"
        if: failure()
        run: |
          echo "================================================"
          echo "Collecting logs for debugging"
          echo "================================================"

          # Create logs directory
          mkdir -p ci-logs

          # Collect DSpace logs
          vagrant ssh -c "sudo tar -czf /tmp/dspace-logs.tar.gz /opt/dspace/log/ 2>/dev/null || true"
          vagrant scp dspace-server:/tmp/dspace-logs.tar.gz ci-logs/ || true

          # Collect system logs
          vagrant ssh -c "sudo journalctl -xe --no-pager > /tmp/system.log"
          vagrant scp dspace-server:/tmp/system.log ci-logs/ || true

          # Collect service status
          vagrant ssh -c "sudo systemctl status postgresql tomcat solr --no-pager > /tmp/services.log 2>&1"
          vagrant scp dspace-server:/tmp/services.log ci-logs/ || true

          # Show last 50 lines of logs in CI output
          echo ""
          echo "Recent system logs:"
          tail -n 50 ci-logs/system.log || true

          echo ""
          echo "Service status:"
          cat ci-logs/services.log || true

      # ======================================================================
      # Step 10: Upload Test Artifacts
      # ======================================================================
      - name: "ðŸ’¾ Upload test artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vagrant-test-logs-${{ github.run_number }}
          path: ci-logs/
          retention-days: 7
          if-no-files-found: ignore

      # ======================================================================
      # Step 11: Cleanup
      # ======================================================================
      - name: "ðŸ§¹ Cleanup Vagrant VM"
        if: always()
        run: |
          echo "================================================"
          echo "Cleaning up Vagrant VM"
          echo "================================================"

          # Destroy the VM to free resources
          vagrant destroy -f || true

          # Remove Vagrant files
          rm -rf .vagrant || true

          echo "âœ… Cleanup complete"

# ============================================================================
# End of Vagrant CI Testing Workflow
# ============================================================================